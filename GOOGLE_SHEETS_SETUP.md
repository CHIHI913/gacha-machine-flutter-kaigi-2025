# Googleスプレッドシート連携セットアップガイド

このドキュメントは、Flutter Kaigi 2025 ガチャアプリを **Google Apps Script (GAS)** 経由で Google スプレッドシートと連携させる手順をまとめたものです。

## 目次

1. [概要](#概要)
2. [スプレッドシートの準備](#スプレッドシートの準備)
3. [Google Apps Scriptの設定](#google-apps-scriptの設定)
4. [アプリ側の設定](#アプリ側の設定)
5. [動作確認](#動作確認)
6. [トラブルシューティング](#トラブルシューティング)

---

## 概要

アプリは2種類のデータソースをサポートしています。

- **ローカルストレージ**: ブラウザ内に保存（デフォルト）
- **Googleスプレッドシート**: 複数端末で共有可能

Googleスプレッドシートを利用する場合、Apps Script で公開した Web API を経由してデータを読み書きします。

---

## スプレッドシートの準備

1. 新しいスプレッドシートを作成（既存でも可）。
2. 1行目に以下のヘッダーを設定します。

| A列 | B列 | C列 | D列 | E列 | F列 | G列 |
|-----|-----|-----|-----|-----|-----|-----|
| ID | 名前 | 画像URL | 在庫（残数） | 仕入れ総数 | 説明 | 作成日時 |

3. サンプルデータを入れる場合の例：

| ID | 名前 | 画像URL | 在庫 | 仕入れ総数 | 説明 | 作成日時 |
|----|------|---------|------|------------|------|----------|
| sample-1 | サンプル景品 | https://placehold.co/200 | 10 | 20 | テストデータ | 2025-01-01 |

---

## Google Apps Scriptの設定

### 1. エディタを開く

1. スプレッドシートを開いた状態で「拡張機能」→「Apps Script」。
2. 初期コードをすべて削除します。

### 2. コードの貼り付け

`google-apps-script/Code.gs` の内容をコピーしてApps Scriptエディタに貼り付けます。必要に応じて `SHEET_NAME` を実際のシート名に変更してください。

### 3. Webアプリとしてデプロイ

1. エディタ右上の「デプロイ」→「新しいデプロイ」。
2. 「種類を選択」で **ウェブアプリ** を選択。
3. 以下の設定を行います。
   - 説明: 任意（例: Gacha API）
   - 次のユーザーとして実行: **自分**
   - アクセスできるユーザー: ユースケースに応じて
     - **全員（匿名）**…誰でも利用可（個人アカウント向け）
     - **Googleアカウントを持つ全員**…Googleログイン必須
     - **会社の全員**…同じドメインのユーザーのみ
4. 「デプロイ」をクリックし、表示される認可フローを完了します（「詳細」→「～に移動」→「許可」）。
5. 表示された **`https://script.google.com/macros/s/.../exec`** のURLをコピーしてメモ。

> **重要**: オーナー自身が `/exec` URL にアクセスして承認を完了するまで、他ユーザーは利用できません。

---

## アプリ側の設定

1. プロジェクトルートで `.env.example` をコピーし `.env` を作成。

```bash
cp .env.example .env
```

2. `.env` に Apps Script の `/exec` URL を設定。

```env
VITE_GOOGLE_SHEETS_API_URL=https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXX/exec
```

3. `npm run dev` を再起動し、設定画面（⚙️）でデータソースのトグルを「スプレッドシート」に切り替えます。

---

## 動作確認

1. アプリ起動直後にスプレッドシート内のデータが一覧に表示されるか確認。
2. 景品を追加し、スプレッドシートに新しい行が追加されるか確認。
3. 景品を編集・削除し、対応するセルが更新・削除されるか確認。
4. ガチャ実行後に在庫数が1ずつ減少するか確認。

---

## トラブルシューティング

|症状|チェックポイント|
|----|----------------|
|モーダルに「ネットワークエラー: Failed to fetch」|インターネット接続 / Apps Script URL / ブラウザのCORSエラーを確認。シークレットモードでGoogleログインできているか。|
|`HTTPエラー (ステータスコード: 401/403)`|「アクセスできるユーザー」の設定と、利用者のGoogleアカウントを確認。会社アカウントの場合は同一ドメインでログインが必要。|
|`Apps Scriptエラー: ...`|Apps Script メニュー → 「実行数」からログを確認。シート名や列構成が正しいか。|
|データが空で表示される|シートのID列が空になっていないか、`SHEET_NAME` が実際のタブ名と一致しているかを確認。|
|更新・削除が反映されない|Apps Script の権限が再び必要になっていないか（認証ダイアログが裏で開いていないか）確認。|

### その他のヒント

- 公開URLを新しく発行した場合は、`.env` を更新し開発サーバーを再起動してください。
- 企業ドメインで「全員（匿名）」が選べない場合は「Googleアカウントを持つ全員」を選択し、利用者にはGoogleログインしてもらいます。
- ブラウザのDevTools (F12) → Networkタブを確認すると、失敗したリクエストの詳細なレスポンスが確認できます。

---

これでApps Script経由のGoogleスプレッドシート連携が利用可能になります。
